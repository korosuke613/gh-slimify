# This is a test workflow file for integration testing.
# GitHub Actions is disabled for this workflow.
name: Integration Test - Complex Workflow_test

on:
  push:
    branches:
      - 'never-run-this-workflow'
  pull_request:
    branches:
      - 'never-run-this-workflow'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.21'
  BUILD_DIR: build

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run gofmt
        run: gofmt -l . | tee /tmp/gofmt.out || true
      
      - name: Check formatting
        run: |
          if [ -s /tmp/gofmt.out ]; then
            echo "Code is not formatted"
            exit 1
          fi

  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.21', '1.22']
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      
      - name: Run unit tests
        run: go test -v -race ./...
      
      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.go-version == '1.21'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.out
          if-no-files-found: ignore

  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Build
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          go build -o ${{ env.BUILD_DIR }}/slimify ./cmd/slimly
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ${{ env.BUILD_DIR }}/*
          retention-days: 7

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'release' && github.event.action == 'published')
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://example.com
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Deploy
        run: |
          echo "Deploying to ${{ github.event.inputs.environment || 'production' }}"
          echo "Deployment URL: ${{ env.DEPLOYMENT_URL }}"

# Expected results when running 'gh slimfy':
# - 3 candidate jobs detected: lint, build, deploy
#   - lint: runs-on: ubuntu-latest ✓, no Docker/containers/services ✓
#   - test: runs-on: ${{ matrix.os }} ✗ (matrix variable, not literal "ubuntu-latest")
#   - build: runs-on: ubuntu-latest ✓, no Docker/containers/services ✓
#   - deploy: runs-on: ubuntu-latest ✓, no Docker/containers/services ✓
# - Output: ".github/workflows/_test_complex_test.yml\n  - job \"lint\" (L40) → ubuntu-slim compatible\n  - job \"build\" (L91) → ubuntu-slim compatible\n  - job \"deploy\" (L116) → ubuntu-slim compatible\n\nTotal: 3 job(s) can be safely migrated."


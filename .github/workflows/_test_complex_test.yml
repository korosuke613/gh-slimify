# This is a test workflow file for integration testing.
# GitHub Actions is disabled for this workflow.
name: Integration Test - Complex Docker Workflow_test

on:
  push:
    branches:
      - 'never-run-this-workflow'
  pull_request:
    branches:
      - 'never-run-this-workflow'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.21'
  BUILD_DIR: build
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: test-app

jobs:
  docker-lint:
    name: Docker Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
        continue-on-error: true
      
      - name: Build Dockerfile for linting
        run: |
          docker build --target builder -t test-lint:latest -f - <<EOF
          FROM golang:1.21-alpine AS builder
          WORKDIR /app
          COPY go.mod go.sum ./
          RUN go mod download
          COPY . .
          RUN gofmt -l . | tee /tmp/gofmt.out || true
          RUN if [ -s /tmp/gofmt.out ]; then exit 1; fi
          EOF

  docker-test:
    name: Docker Test Suite
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, e2e]
        go-version: ['1.21', '1.22']
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build test image
        run: |
          docker build -t test-${{ matrix.test-type }}:${{ matrix.go-version }} -f - <<EOF
          FROM golang:${{ matrix.go-version }}-alpine
          WORKDIR /app
          COPY go.mod go.sum ./
          RUN go mod download
          COPY . .
          RUN go test -v -race ./... -run ${{ matrix.test-type }} || true
          EOF
      
      - name: Run tests in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            golang:${{ matrix.go-version }}-alpine \
            sh -c "go test -v -race ./..."
        env:
          TEST_TYPE: ${{ matrix.test-type }}
      
      - name: Upload test results
        if: matrix.test-type == 'unit'
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.go-version }}
          path: test-results.xml
          if-no-files-found: ignore

  docker-build:
    name: Multi-stage Docker Build
    runs-on: ubuntu-latest
    needs: [docker-lint, docker-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
      
      - name: Save Docker image
        run: |
          docker save ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:latest -o image.tar
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v5
        with:
          name: docker-image
          path: image.tar
          retention-days: 7

  docker-deploy:
    name: Docker Deploy
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'release' && github.event.action == 'published')
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://example.com
    container:
      image: docker:29-dind
      options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Download Docker image artifact
        uses: actions/download-artifact@v6
        with:
          name: docker-image
      
      - name: Load Docker image
        run: docker load -i image.tar
      
      - name: Deploy with Docker Compose
        run: |
          docker compose -f docker-compose.deploy.yml up -d
          docker ps
          docker logs test-app || echo "Container logs"

# Expected results when running 'gh slimfy':
# - 0 candidate jobs detected
#   - docker-lint: runs-on: ubuntu-latest ✓, but has Docker commands ✗
#   - docker-test: runs-on: ubuntu-latest ✓, but has Docker commands and container actions ✗
#   - docker-build: runs-on: ubuntu-latest ✓, but has Docker commands ✗
#   - docker-deploy: runs-on: ubuntu-latest ✓, but has container syntax ✗
# - Output: "No jobs found that can be safely migrated to ubuntu-slim."


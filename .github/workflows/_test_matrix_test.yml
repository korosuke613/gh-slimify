# This is a test workflow file for integration testing.
# GitHub Actions is disabled for this workflow.
name: Integration Test - Docker Matrix Strategy_test

on:
  push:
    branches:
      - 'never-run-this-workflow'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        type: choice
        options:
          - unit
          - integration
          - e2e

jobs:
  docker-matrix-build:
    name: Docker Build - ${{ matrix.base-image }} - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        base-image:
          - golang:1.21-alpine
          - golang:1.22-alpine
          - golang:1.23-alpine
        arch:
          - amd64
          - arm64
        include:
          - base-image: golang:1.21-alpine
            arch: amd64
            test-suite: extended
            dockerfile-type: multi-stage
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Display matrix info
        run: |
          echo "Base Image: ${{ matrix.base-image }}"
          echo "Architecture: ${{ matrix.arch }}"
          echo "Test Suite: ${{ matrix.test-suite || 'default' }}"
          echo "Dockerfile Type: ${{ matrix.dockerfile-type || 'single-stage' }}"
      
      - name: Build Docker image
        run: |
          if [ "${{ matrix.dockerfile-type }}" = "multi-stage" ]; then
            docker buildx build \
              --platform linux/${{ matrix.arch }} \
              --tag test-app:${{ matrix.base-image }}-${{ matrix.arch }} \
              -f - <<EOF
          FROM ${{ matrix.base-image }} AS builder
          WORKDIR /app
          COPY go.mod go.sum ./
          RUN go mod download
          COPY . .
          RUN go build -o app ./cmd/slimly
          
          FROM alpine:latest
          COPY --from=builder /app/app /usr/local/bin/app
          ENTRYPOINT ["/usr/local/bin/app"]
          EOF
          else
            docker buildx build \
              --platform linux/${{ matrix.arch }} \
              --tag test-app:${{ matrix.base-image }}-${{ matrix.arch }} \
              -f - <<EOF
          FROM ${{ matrix.base-image }}
          WORKDIR /app
          COPY go.mod go.sum ./
          RUN go mod download
          COPY . .
          RUN go build -o app ./cmd/slimly
          CMD ["./app"]
          EOF
          fi
      
      - name: Test Docker image
        run: |
          docker run --rm --platform linux/${{ matrix.arch }} \
            test-app:${{ matrix.base-image }}-${{ matrix.arch }} \
            --version || echo "Version test completed"
      
      - name: Inspect image layers
        run: |
          docker history test-app:${{ matrix.base-image }}-${{ matrix.arch }} | head -10
          docker images test-app:${{ matrix.base-image }}-${{ matrix.arch }}

  docker-matrix-test:
    name: Docker Test - ${{ matrix.test-type }} - ${{ matrix.go-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-type:
          - unit
          - integration
          - e2e
        go-version:
          - '1.21'
          - '1.22'
        include:
          - test-type: unit
            go-version: '1.23'
            coverage: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Run tests in Docker container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            golang:${{ matrix.go-version }}-alpine \
            sh -c "go test -v ./... -run ${{ matrix.test-type }}"
        env:
          TEST_TYPE: ${{ matrix.test-type }}
          GO_VERSION: ${{ matrix.go-version }}
      
      - name: Build test container
        run: |
          docker build -t test-${{ matrix.test-type }}:${{ matrix.go-version }} -f - <<EOF
          FROM golang:${{ matrix.go-version }}-alpine
          WORKDIR /app
          COPY go.mod go.sum ./
          RUN go mod download
          COPY . .
          RUN go test -v ./... -run ${{ matrix.test-type }} ${{ matrix.coverage && '-coverprofile=coverage.out' || '' }}
          EOF
      
      - name: Extract coverage
        if: matrix.coverage == true
        run: |
          docker create --name temp-container test-${{ matrix.test-type }}:${{ matrix.go-version }}
          docker cp temp-container:/app/coverage.out coverage-${{ matrix.test-type }}-${{ matrix.go-version }}.out || echo "Coverage file not found"
          docker rm temp-container
      
      - name: Upload coverage
        if: matrix.coverage == true
        uses: actions/upload-artifact@v5
        with:
          name: coverage-${{ matrix.test-type }}-${{ matrix.go-version }}
          path: coverage-${{ matrix.test-type }}-${{ matrix.go-version }}.out
          if-no-files-found: ignore

# Expected results when running 'gh slimfy':
# - 0 candidate jobs detected
#   - docker-matrix-build: runs-on: ubuntu-latest ✓, but has Docker commands ✗
#   - docker-matrix-test: runs-on: ubuntu-latest ✓, but has Docker commands and container actions ✗
# - Output: "No jobs found that can be safely migrated to ubuntu-slim."

